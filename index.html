<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Danh sách</title>
  <style>
    .hidden 
    {
      display: none;
    }
    .book 
    {
      margin: 40px;
      padding: 10px;
      background-color: #eee;
      cursor: pointer;
    }
    #morse 
    {
       white-space: pre-wrap; /* tự xuống dòng khi quá dài */
       word-break: break-word; /* ngắt từ khi cần */
    }
    #speedControl 
    {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #007bff;
  color: white;
  padding: 10px 14px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  z-index: 999;
     }

  </style>
</head>
<body>
  <button id="speedControl" onclick="changeSpeed()">Tốc độ: 1x</button>
  <!-- Trang chủ: Danh sách sách -->
  <div id="home">
    <h1>Danh sách sách giáo khoa</h1>
    <div class="book" onclick="showDetail('toan')">Sách Toán</div>
    <div class="book" onclick="showDetail('van')">Sách Văn</div>
  </div>

  <!-- Trang chi tiết -->
  <div id="detail" class="hidden">
    <h2 id="bookTitle"></h2>
    <p id="bookInfo"></p>
    <pre id="morse"></pre>
    <button onclick="vibrateMorse()">Bắt đầu rung</button>
    <button onclick="goHome()">Quay lại</button>
  </div>

  <script>
    const morseMap = {
      A: '.-', B: '-...', C: '-.-.', D: '-..', E: '.', F: '..-.',
      G: '--.', H: '....', I: '..', J: '.---', K: '-.-', L: '.-..',
      M: '--', N: '-.', O: '---', P: '.--.', Q: '--.-', R: '.-.',
      S: '...', T: '-', U: '..-', V: '...-', W: '.--', X: '-..-',
      Y: '-.--', Z: '--..',
      0: '-----', 1: '.----', 2: '..---', 3: '...--',
      4: '....-', 5: '.....', 6: '-....', 7: '--...', 8: '---..', 9: '----.',
      ' ': '/'
    };
    
    function normalizeVietnamese(text) 
    {
     return text
    .normalize('NFD')                        // tách các ký tự dấu ra
    .replace(/[\u0300-\u036f]/g, '')        // loại bỏ các ký tự dấu
    .replace(/đ/g, 'd')
    .replace(/Đ/g, 'D');
    }

    function textToMorse(text) 
    {
      return text.toUpperCase().split('').map(char => morseMap[char] || '').join(' ');
    }

    function showDetail(book) 
    {
  document.getElementById("home").classList.add("hidden");
  document.getElementById("detail").classList.remove("hidden");

  // Tùy theo sách nào thì đặt tiêu đề tương ứng
  let title = '';
  if (book === 'toan') title = 'Sách Toán lớp 9';
  else if (book === 'van') title = 'Sách Ngữ Văn lớp 9';
  else title = 'Sách';

  document.getElementById("bookTitle").innerText = title;

  // Tải nội dung từ file tương ứng
  fetch(`data/${book}.txt`)
    .then(res => res.text())
    .then(text => {
      document.getElementById("bookInfo").innerText = text;
      const noTone = normalizeVietnamese(text);
      const morse = textToMorse(noTone);

      // Gói từng ký tự Morse vào span để có thể highlight
      const highlighted = morse.split('').map((c, i) => `<span id="m${i}">${c}</span>`).join('');
      document.getElementById("morse").innerHTML = highlighted;
    });
  }
    function vibrateMorse() {
  const morseSpans = document.querySelectorAll("#morse span");
  let i = 0;

  function step() {
    if (i >= morseSpans.length) return;

    // Xóa highlight trước đó
    if (i > 0) morseSpans[i - 1].style.background = "";

    const char = morseSpans[i].innerText;
    morseSpans[i].style.background = "yellow";

    let duration = 0;
    if (char === '.') duration = 100;
    else if (char === '-') duration = 300;
    else if (char === ' ') duration = 0;    // khoảng cách giữa chữ
    else if (char === '/') duration = 0;    // khoảng cách giữa từ

    navigator.vibrate(duration);

    i++;
    setTimeout(step, (duration + 150) / speedMultiplier);
    if (i === morseSpans.length) morseSpans[i - 1].style.background = "";

  }

  step();
}
let speedMultiplier = 1; // Mặc định 1x

ffunction changeSpeed() {
  if (speedMultiplier === 1) {
    speedMultiplier = 2;
  } else if (speedMultiplier === 2) {
    speedMultiplier = 0.5;
  } else {
    speedMultiplier = 1;
  }

  document.getElementById("speedControl").innerText = `Tốc độ: ${speedMultiplier}x`;
}

    function goHome() 
    {
      document.getElementById("home").classList.remove("hidden");
      document.getElementById("detail").classList.add("hidden");
    }
  </script>

  </body>
</html>
